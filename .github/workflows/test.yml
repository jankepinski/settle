name: Tests
on: [push, pull_request]

jobs:
  unit-tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter api prisma:generate
      - run: pnpm --filter api test:unit
      - run: pnpm --filter web test

  integration-tests:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_USER: splitwise_test
          POSTGRES_PASSWORD: splitwise_test
          POSTGRES_DB: splitwise_test
        ports:
          - 5433:5432
        options: >-
          --health-cmd="pg_isready -U splitwise_test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: pnpm
      - run: pnpm install --frozen-lockfile
      - run: pnpm --filter api prisma:generate
      - run: pnpm --filter api exec prisma migrate deploy
        env:
          DATABASE_URL: postgresql://splitwise_test:splitwise_test@localhost:5433/splitwise_test?schema=public
      - run: pnpm --filter api test:integration
        env:
          DATABASE_URL: postgresql://splitwise_test:splitwise_test@localhost:5433/splitwise_test?schema=public
      - run: pnpm --filter api test:e2e
        env:
          DATABASE_URL: postgresql://splitwise_test:splitwise_test@localhost:5433/splitwise_test?schema=public
          JWT_ACCESS_SECRET: ci-test-access-secret
          JWT_REFRESH_SECRET: ci-test-refresh-secret
          JWT_ACCESS_EXPIRES_IN: 900
          JWT_REFRESH_EXPIRES_IN: 604800
